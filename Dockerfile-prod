# ---------- STAGE 1: Build ----------
FROM node:22-alpine@sha256:dbcedd8aeab47fbc0f4dd4bffa55b7c3c729a707875968d467aaaea42d6225af AS builder

ENV NODE_ENV production

RUN apk update && apk upgrade && apk add bash

SHELL ["/bin/bash", "-c"]

WORKDIR /app

COPY \
  package.json ./ \
  pnpm-lock.yaml ./ \
  tsconfig.json ./ \
  tsconfig.build.json ./ \
  .env ./ \
  topic.json ./ \
  swagger-description*.md ./ \
  nest-cli.json ./

RUN npm install --global pnpm \
    && SHELL=bash pnpm setup \
    && source /root/.bashrc

ENV PNPM_HOME=/usr/local/bin

COPY src /app/src

RUN pnpm install --frozen-lockfile --prod && pnpm build

# ---------- STAGE 2: Runtime ----------
FROM node:22-slim@sha256:d943bf20249f8b92eff6f605362df2ee9cf2d6ce2ea771a8886e126ec8714f08 AS runtime

# Nur das Nötigste
WORKDIR /app

# Nur Runtime-Abhängigkeiten
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/topic.json ./
COPY --from=builder /app/swagger-description*.md ./
COPY --from=builder /app/.env ./

ARG APP_UID=1001
ARG APP_GID=1001

RUN addgroup -g ${APP_GID} appgroup || echo "Group already exists" && \
    adduser -u ${APP_UID} -G appgroup -s /bin/sh -D appuser || echo "User already exists"

USER ${APP_UID}

# Start der App
CMD ["node", "dist/main.js"]
