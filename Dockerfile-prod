# ---------- STAGE 1: Build ----------
FROM node:20-alpine@sha256:1ab6fc5a31d515dc7b6b25f6acfda2001821f2c2400252b6cb61044bd9f9ad48 AS builder

ENV NODE_ENV production

RUN apk update && apk upgrade && apk add bash

SHELL ["/bin/bash", "-c"]

WORKDIR /app

COPY \
  package.json ./ \
  pnpm-lock.yaml ./ \
  tsconfig.json ./ \
  tsconfig.build.json ./ \
  .env ./ \
  topic.json ./ \
  swagger-description*.md ./ \
  nest-cli.json ./

RUN npm install --global pnpm \
    && SHELL=bash pnpm setup \
    && source /root/.bashrc

ENV PNPM_HOME=/usr/local/bin

COPY src /app/src

RUN pnpm install --frozen-lockfile --prod && pnpm build

# ---------- STAGE 2: Runtime ----------
FROM node:20-slim@sha256:f679d7699517426eb148a5698c717477fd3f8a48f6c1eaf771e390a9bb8268c8 AS runtime

WORKDIR /app

# only copy relevant runtime dependencies
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/topic.json ./
COPY --from=builder /app/swagger-description*.md ./
COPY --from=builder /app/.env ./

ARG APP_UID=1001
ARG APP_GID=1001

RUN addgroup -g ${APP_GID} appgroup || echo "Group already exists" && \
    adduser -u ${APP_UID} -G appgroup -s /bin/sh -D appuser || echo "User already exists"

USER ${APP_UID}

# starting the app
CMD ["node", "dist/main.js"]
